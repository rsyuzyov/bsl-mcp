<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Поиск по ИБ {{ config_name }}</title>
<style>
body{font-family:system-ui;max-width:900px;margin:40px auto;padding:0 20px}
input{width:60%;padding:8px;font-size:14px}
button{padding:6px 12px;font-size:12px;margin:2px;cursor:pointer}
.result{border:1px solid #ddd;margin:10px 0;padding:15px;border-radius:5px}
.file{color:#666;font-size:12px}.score{color:#090;font-weight:bold}
pre{background:#f5f5f5;padding:10px;overflow-x:auto;font-size:13px}
.btn-full{background:#dc3545;color:#fff;border:none}
.btn-inc{background:#28a745;color:#fff;border:none}
#status{margin:10px 0;padding:15px;border-radius:5px;display:none}
.progress-bar{background:#e9ecef;border-radius:5px;height:20px;margin:10px 0}
.progress-fill{background:#007bff;height:100%;border-radius:5px;transition:width 0.3s}
.stats{font-size:13px;color:#666;margin-top:5px}
.header{display:flex;align-items:center;gap:15px;margin-bottom:20px}
.header h1{margin:0;font-size:1.3em}
.dropdown{position:relative;display:inline-block}
.dropdown-btn{background:#6c757d;color:#fff;border:none;padding:6px 12px;font-size:12px;cursor:pointer;border-radius:3px}
.dropdown-content{display:none;position:absolute;background:#fff;min-width:140px;box-shadow:0 2px 8px rgba(0,0,0,0.15);z-index:1;border-radius:3px}
.dropdown-content button{width:100%;text-align:left;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:12px}
.dropdown-content button:hover{background:#f0f0f0}
.dropdown:hover .dropdown-content{display:block}
</style></head>
<body>
<div class="header">
<h1>Поиск по ИБ {{ config_name }}</h1>
</div>
<form onsubmit="search();return false"><input id="q" placeholder="Поиск по коду 1С..." autofocus>
<button>Найти</button>
<div class="dropdown"><button type="button" class="dropdown-btn">Индексация ▾</button>
<div class="dropdown-content">
<button type="button" onclick="reindex('incremental')">Обновить</button>
<button type="button" onclick="reindex('full')">Пересоздать</button>
</div></div></form>
<div id="status"></div>
<div id="results"></div>
<script>
let pollInterval = null;

async function search(){
    const q=document.getElementById('q').value;
    const r=document.getElementById('results');
    r.innerHTML='Поиск...';
    const res=await fetch('/search?q='+encodeURIComponent(q));
    const data=await res.json();
    r.innerHTML=data.map(d=>`<div class="result"><span class="score">${d.score.toFixed(3)}</span> <span class="match">[${d.match}]</span>
<div class="file">${d.file}</div><pre>${d.text.replace(/</g,'&lt;')}</pre></div>`).join('')||'Ничего не найдено';
}

async function reindex(mode){
    const msg=mode==='full'?'Переиндексация удалит весь индекс. Продолжить?':'Обновить индекс?';
    if(!confirm(msg))return;
    fetch('/reindex/'+mode,{method:'POST'});
    startPolling();
}

function startPolling(){
    const s=document.getElementById('status');
    s.style.display='block';
    if(pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(updateProgress, 5000);
    updateProgress();
}

async function updateProgress(){
    const s=document.getElementById('status');
    try {
        const res = await fetch('/indexing-progress');
        const d = await res.json();
        if(!d.running && !d.mode){
            s.style.display='none';
            if(pollInterval){clearInterval(pollInterval);pollInterval=null;}
            return;
        }
        s.style.display='block';
        const mode = d.mode === 'full' ? 'Полная индексация' : 'Обновление';
        if(d.running){
            s.style.background='#fff3cd';
            if(d.total_files === 0){
                s.innerHTML = `<b>⏳ ${mode}</b><div class="stats">Подготовка... | Начало: ${d.started}</div>`;
            } else {
                s.innerHTML = `<b>⏳ ${mode}</b>
<div class="progress-bar"><div class="progress-fill" style="width:${d.pct}%"></div></div>
<div class="stats">[${d.pct}%] ${d.processed_files}/${d.total_files} | в базе: ${d.collection_count} | проиндексировано: ${d.indexed} | ${d.speed}/с | начало: ${d.started} | прошло: ${d.elapsed} | конец: ${d.eta_time}</div>
<div class="stats" style="font-size:11px;color:#999">${d.last_file} ${d.status_detail ? '(' + d.status_detail + ')' : ''}</div>`;
            }
            if(!pollInterval) startPolling();
        } else if(d.error){
            s.style.background='#f8d7da';
            s.innerHTML=`❌ Ошибка: ${d.error}`;
            if(pollInterval){clearInterval(pollInterval);pollInterval=null;}
        } else {
            s.style.background='#d4edda';
            s.innerHTML=`✅ Готово! Файлов: ${d.processed_files}, в базе: ${d.collection_count}, время: ${d.elapsed}`;
            if(pollInterval){clearInterval(pollInterval);pollInterval=null;}
        }
    } catch(e) {
        console.error(e);
    }
}
setInterval(updateProgress, 5000);
updateProgress();
</script></body></html>
