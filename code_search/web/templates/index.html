<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>–ü–æ–∏—Å–∫ –ø–æ –ò–ë {{ config_name }}</title>
<style>
body{font-family:system-ui;max-width:900px;margin:40px auto;padding:0 20px}
input{width:60%;padding:8px;font-size:14px}
button{padding:6px 12px;font-size:12px;margin:2px;cursor:pointer}
.result{border:1px solid #ddd;margin:10px 0;padding:15px;border-radius:5px}
.file{color:#666;font-size:12px}.score{color:#090;font-weight:bold}
pre{background:#f5f5f5;padding:10px;overflow-x:auto;font-size:13px}
.btn-full{background:#dc3545;color:#fff;border:none}
.btn-inc{background:#28a745;color:#fff;border:none}
#status{margin:10px 0;padding:15px;border-radius:5px;display:none}
.progress-bar{background:#e9ecef;border-radius:5px;height:20px;margin:10px 0}
.progress-fill{background:#007bff;height:100%;border-radius:5px;transition:width 0.3s}
.stats{font-size:13px;color:#666;margin-top:5px}
.header{display:flex;align-items:center;gap:15px;margin-bottom:20px}
.header h1{margin:0;font-size:1.3em}
</style></head>
<body>
<div class="header">
<h1>üîç –ü–æ–∏—Å–∫ –ø–æ –ò–ë {{ config_name }}</h1>
<button class="btn-inc" onclick="reindex('incremental')">–û–±–Ω–æ–≤–∏—Ç—å</button>
<button class="btn-full" onclick="reindex('full')">–ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å</button>
</div>
<form onsubmit="search();return false"><input id="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É 1–°..." autofocus>
<button>–ù–∞–π—Ç–∏</button></form>
<div id="status"></div>
<div id="results"></div>
<script>
let pollInterval = null;

async function search(){
    const q=document.getElementById('q').value;
    const r=document.getElementById('results');
    r.innerHTML='–ü–æ–∏—Å–∫...';
    const res=await fetch('/search?q='+encodeURIComponent(q));
    const data=await res.json();
    r.innerHTML=data.map(d=>`<div class="result"><span class="score">${d.score.toFixed(3)}</span> <span class="match">[${d.match}]</span>
<div class="file">${d.file}</div><pre>${d.text.replace(/</g,'&lt;')}</pre></div>`).join('')||'–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
}

async function reindex(mode){
    const msg=mode==='full'?'–ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —É–¥–∞–ª–∏—Ç –≤–µ—Å—å –∏–Ω–¥–µ–∫—Å. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?':'–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å?';
    if(!confirm(msg))return;
    fetch('/reindex/'+mode,{method:'POST'});
    startPolling();
}

function startPolling(){
    const s=document.getElementById('status');
    s.style.display='block';
    if(pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(updateProgress, 5000);
    updateProgress();
}

async function updateProgress(){
    const s=document.getElementById('status');
    try {
        const res = await fetch('/indexing-progress');
        const d = await res.json();
        if(!d.running && !d.mode){
            s.style.display='none';
            if(pollInterval){clearInterval(pollInterval);pollInterval=null;}
            return;
        }
        s.style.display='block';
        const mode = d.mode === 'full' ? '–ü–æ–ª–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è' : '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
        if(d.running){
            s.style.background='#fff3cd';
            if(d.total_files === 0){
                s.innerHTML = `<b>‚è≥ ${mode}</b><div class="stats">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞... | –ù–∞—á–∞–ª–æ: ${d.started}</div>`;
            } else {
                s.innerHTML = `<b>‚è≥ ${mode}</b>
<div class="progress-bar"><div class="progress-fill" style="width:${d.pct}%"></div></div>
<div class="stats">[${d.pct}%] ${d.processed_files}/${d.total_files} | –≤ –±–∞–∑–µ: ${d.collection_count} | –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–æ: ${d.indexed} | ${d.speed}/—Å | –Ω–∞—á–∞–ª–æ: ${d.started} | –ø—Ä–æ—à–ª–æ: ${d.elapsed} | –∫–æ–Ω–µ—Ü: ${d.eta_time}</div>
<div class="stats" style="font-size:11px;color:#999">${d.last_file} ${d.status_detail ? '(' + d.status_detail + ')' : ''}</div>`;
            }
            if(!pollInterval) startPolling();
        } else if(d.error){
            s.style.background='#f8d7da';
            s.innerHTML=`‚ùå –û—à–∏–±–∫–∞: ${d.error}`;
            if(pollInterval){clearInterval(pollInterval);pollInterval=null;}
        } else {
            s.style.background='#d4edda';
            s.innerHTML=`‚úÖ –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª–æ–≤: ${d.processed_files}, –≤ –±–∞–∑–µ: ${d.collection_count}, –≤—Ä–µ–º—è: ${d.elapsed}`;
            if(pollInterval){clearInterval(pollInterval);pollInterval=null;}
        }
    } catch(e) {
        console.error(e);
    }
}
setInterval(updateProgress, 5000);
updateProgress();
</script></body></html>
