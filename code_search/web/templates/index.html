<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>–ü–æ–∏—Å–∫ –ø–æ –ò–ë {{ config_name }}</title>
<style>
body{font-family:system-ui;max-width:900px;margin:40px auto;padding:0 20px}
input{width:60%;padding:8px;font-size:14px}
button{padding:6px 12px;font-size:12px;margin:2px;cursor:pointer}
.result{border:1px solid #ddd;margin:10px 0;padding:15px;border-radius:5px}
.file{color:#666;font-size:12px}.score{color:#090;font-weight:bold}
pre{background:#f5f5f5;padding:10px;overflow-x:auto;font-size:13px}
.btn-full{background:#dc3545;color:#fff;border:none}
.btn-inc{background:#28a745;color:#fff;border:none}
#status{margin:10px 0;padding:15px;border-radius:5px;display:none}
.progress-bar{background:#e9ecef;border-radius:5px;height:20px;margin:10px 0}
.progress-fill{background:#007bff;height:100%;border-radius:5px;transition:width 0.3s}
.stats{font-size:13px;color:#666;margin-top:5px}
.header{display:flex;align-items:center;gap:15px;margin-bottom:20px}
.header h1{margin:0;font-size:1.3em}
</style></head>
<body>
<div class="header">
<h1>üîç –ü–æ–∏—Å–∫ –ø–æ –ò–ë {{ config_name }}</h1>
<button class="btn-inc" onclick="reindex('incremental')">–û–±–Ω–æ–≤–∏—Ç—å</button>
<button class="btn-full" onclick="reindex('full')">–ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å</button>
</div>
<form onsubmit="search();return false"><input id="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É 1–°..." autofocus>
<button>–ù–∞–π—Ç–∏</button></form>
<div id="status"></div>
<div id="results"></div>
<script>
let pollInterval = null;

async function search(){
    const q=document.getElementById('q').value;
    const r=document.getElementById('results');
    r.innerHTML='–ü–æ–∏—Å–∫...';
    const res=await fetch('/search?q='+encodeURIComponent(q));
    const data=await res.json();
    r.innerHTML=data.map(d=>`<div class="result"><span class="score">${d.score.toFixed(3)}</span> <span class="match">[${d.match}]</span>
<div class="file">${d.file}</div><pre>${d.text.replace(/</g,'&lt;')}</pre></div>`).join('')||'–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
}

async function reindex(mode){
    const msg=mode==='full'?'–ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —É–¥–∞–ª–∏—Ç –≤–µ—Å—å –∏–Ω–¥–µ–∫—Å. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?':'–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å?';
    if(!confirm(msg))return;
    fetch('/reindex/'+mode,{method:'POST'});
    startPolling();
}

function startPolling(){
    const s=document.getElementById('status');
    s.style.display='block';
    if(pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(updateProgress, 5000);
    updateProgress();
}

async function updateProgress(){
    const s=document.getElementById('status');
    try {
        const res = await fetch('/indexing-status');
        const data = await res.json();
        if(!data.running && !data.mode){
            s.style.display='none';
            if(pollInterval){clearInterval(pollInterval);pollInterval=null;}
            return;
        }
        s.style.display='block';
        const pct = data.total_files > 0 ? Math.round(data.processed_files / data.total_files * 100) : 0;
        const mode = data.mode === 'full' ? '–ü–æ–ª–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è' : '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
        const fmtTime = ts => ts ? new Date(ts * 1000).toLocaleTimeString('ru-RU') : '...';
        const fmtDur = sec => {if(!sec) return '0:00'; sec=Math.round(sec); const m=Math.floor(sec/60),s=sec%60; return m+':'+(s<10?'0':'')+s;};
        const started = fmtTime(data.started_at);
        const elapsedSec = data.started_at ? (Date.now()/1000 - data.started_at) : 0;
        const elapsed = fmtDur(elapsedSec);
        const speed = elapsedSec > 0 ? (data.total_chunks / elapsedSec).toFixed(1) : '0.0';
        const etaTime = fmtTime(data.eta_time);
        if(data.running){
            s.style.background='#fff3cd';
            if(data.total_files === 0){
                s.innerHTML = `<b>‚è≥ ${mode}</b><div class="stats">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞... | –ù–∞—á–∞–ª–æ: ${started}</div>`;
            } else {
                s.innerHTML = `<b>‚è≥ ${mode}</b>
<div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
<div class="stats">–§–∞–π–ª–æ–≤: ${data.processed_files}/${data.total_files} (${pct}%) | –ß–∞–Ω–∫–æ–≤: ${data.total_chunks} | –°–∫–æ—Ä–æ—Å—Ç—å: ${speed}/—Å</div>
<div class="stats">–ù–∞—á–∞–ª–æ: ${started} | –ü—Ä–æ—à–ª–æ: ${elapsed} | –ö–æ–Ω–µ—Ü: ${etaTime}</div>
<div class="stats" style="font-size:11px;color:#999">${data.last_file} ${data.status_detail ? '(' + data.status_detail + ')' : ''}</div>`;
            }
            if(!pollInterval) startPolling();
        } else if(data.error){
            s.style.background='#f8d7da';
            s.innerHTML=`‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
            if(pollInterval){clearInterval(pollInterval);pollInterval=null;}
        } else {
            s.style.background='#d4edda';
            s.innerHTML=`‚úÖ –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª–æ–≤: ${data.processed_files}, —á–∞–Ω–∫–æ–≤: ${data.total_chunks}, –≤—Ä–µ–º—è: ${data.elapsed}—Å`;
            if(pollInterval){clearInterval(pollInterval);pollInterval=null;}
        }
    } catch(e) {
        console.error(e);
    }
}
setInterval(updateProgress, 5000);
updateProgress();
</script></body></html>
